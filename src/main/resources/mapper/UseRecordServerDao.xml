<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.cnic.security.xiandao.dao.UseRecordServerDao">

    <!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="cn.cnic.security.xiandao.entity.UseRecordServerEntity" id="useRecordServerMap">
        <result property="uId" column="u_id"/>
        <result property="createTime" column="create_time"/>
        <result property="serverName" column="server_name"/>
        <result property="memory" column="memory"/>
        <result property="cpuUse" column="cpu_use"/>
        <result property="responseTime" column="response_time"/>
        <result property="throughput" column="throughput"/>
        <result property="queryRate" column="query_rate"/>
        <result property="diskUse" column="disk_use"/>
        <result property="diskSpeed" column="disk_speed"/>
        <result property="bandwidth" column="bandwidth"/>
        <result property="bandwinthDown" column="bandwinth_down"/>
        <result property="processesNumber" column="processes_number"/>
        <result property="warnType" column="warn_type"/>
        <result property="topic" column="topic" />
    </resultMap>


    <select id="lastRecord" resultMap="useRecordServerMap" >
        SELECT
        u.*,
        s.topic
        FROM
            use_record_server u
        LEFT JOIN server_info s ON u.server_name = s.server_ip
        WHERE
            u.u_id IN ( SELECT MAX( u_id ) FROM use_record_server GROUP BY server_name )
    </select>

    <select id="selectPageByTopic" resultMap="useRecordServerMap" >
        SELECT
            u.*,
            s.topic
        FROM
            (SELECT * FROM use_record_server ${ew.customSqlSegment} ) u
        LEFT JOIN server_info s ON u.server_name = s.server_ip
    </select>

    <select id="groupByTopic" resultType="java.util.HashMap">
        SELECT
            topic,
            COUNT( CASE WHEN ( u.warn_type IS NOT NULL ) THEN 0 ELSE 1 END ) count
        FROM
            server_info s
        LEFT JOIN use_record_server u ON s.server_ip = u.server_name
        GROUP BY
            topic
    </select>

</mapper>